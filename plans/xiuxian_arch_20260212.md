# Xiuxian 自动脚本可扩展架构设计 (Telegram / Telethon)

日期：2026-02-12

## 背景

当前仓库只有 `xiuxian.py` 单文件脚本，使用 Telethon 监听群消息并在满足条件时自动发送 `.闭关修炼`，已能覆盖「打坐调息 -> 等待 -> 再次闭关」的闭环。

你希望：在不破坏现有逻辑的前提下，设计一个可持续扩展的架构（后续可加：每日、药园、灵兽、坊市等自动化能力）。

## 目标 (Goals)

- 保留现有「自动闭关修炼」行为与过滤逻辑（话题/名字/回复自己）。
- 形成“传输层(TG) / 领域(修仙规则) / 自动化插件(功能)”的清晰边界，便于新增功能时只加插件。
- 具备最基本的安全护栏：限流、抖动、幂等去重、Dry-run(只打印不发指令)。
- 配置从代码中剥离（至少支持 `.env`/环境变量），避免把账号密钥写死在脚本里。

## 非目标 (Non-Goals)

- 本轮不一次性把所有功能做完；只搭骨架 + 迁移现有闭关插件。
- 不做复杂“脚本 DSL / 图灵完备流程编排器”；先用可读的 Python 插件接口。

## 架构草案 (Draft)

### 1) 分层

1. **tg_adapter（传输层）**
   - 负责：Telethon client 生命周期、NewMessage 订阅、发送消息、基础反垃圾/节流。
   - 对上层暴露统一的 `MessageContext`，屏蔽 Telethon 事件差异。

2. **core（内核）**
   - `Dispatcher`：把消息分发给各插件；支持插件优先级、互斥、吞消息/继续传播。
   - `Scheduler`：提供 `schedule(delay, action, key=...)` 能力，支持相同 key 的任务覆盖/取消（避免重复排队）。
   - `RateLimiter`：全局 + 每插件限流（避免刷屏/封号风险）。
   - `StateStore`（可选）：SQLite/JSON，保存少量状态（最后一次动作时间、待执行任务快照、去重指纹等）。

3. **domain（领域：修仙文本解析）**
   - 只放“解析器/规则”：例如解析「打坐调息 N 分钟」「灵气尚未平复 N分M秒」为结构化 `Cooldown`。
   - 领域层不直接发 TG 消息；只产出“建议动作”。

4. **plugins（功能扩展）**
   - 每个插件只关心自己的触发条件与动作，不关心 Telethon 细节。
   - 插件通过注册“触发器(Trigger)”处理消息，返回 `Action`（立即/延迟发送）或 `None`。

### 2) 关键抽象 (Interfaces)

- `MessageContext`
  - `chat_id/topic_id/message_id/sender_id/is_reply/is_reply_to_me/text/ts`
- `Action`
  - `send(text, reply_to_topic=True, jitter=(min,max), key=...)`
- `Plugin`
  - `name`
  - `enabled`
  - `priority`
  - `async on_message(ctx, api) -> list[Action] | None`
- `PluginAPI`
  - `schedule(...)` / `send(...)` / `log(...)` / `state.get/set(...)`

### 3) 目录结构建议 (可选：单文件也能先做同样分层)

方案 A（推荐）：小包结构，后续扩展成本最低

- `xiuxian_bot/`
  - `app.py`（入口：加载配置、注册插件、启动）
  - `config.py`（环境变量/.env 读取与校验）
  - `tg_adapter.py`（Telethon 封装）
  - `core/dispatcher.py`
  - `core/scheduler.py`
  - `core/rate_limit.py`
  - `domain/parsers.py`
  - `plugins/biguan.py`（把现有逻辑迁移进来）

方案 B：保持单文件，但先把“插件接口/调度器/解析器”按 section 组织

### 4) 现有功能如何落到插件（AutoBiguan）

触发器：

- 收到包含「打坐调息」且（包含我的名字 **或** 回复的是我发的消息）的文本
  - 解析分钟数 -> `schedule(minutes*60 + buffer + jitter)` -> 发送 `.闭关修炼`
- 收到包含「灵气尚未平复」且（包含我的名字 **或** 回复我）的文本
  - 解析 `N分钟M秒` -> `schedule(N*60+M + jitter)` -> 重试发送 `.闭关修炼`

去重/覆盖策略：

- 使用固定 key（如 `biguan.next`）调度任务：新的冷却消息到来时覆盖旧任务，避免重复闭关。

## 安全与稳定性策略 (Guard Rails)

- **身份与上下文过滤**：保留你现在的三重判断（topic / name / reply_to_me），封装成可复用的 `ContextFilter`。
- **发送限流**：全局每分钟上限 + 每插件上限；触发限流时只记录日志不发送。
- **随机抖动**：保留“模拟真人”的 jitter，但让 jitter 可配置。
- **Dry-run**：先跑一段时间只打印将要发送的指令，确认无误再打开真实发送。
- **审计日志**：每次触发记录“触发消息 -> 解析结果 -> 决策动作 -> 实际发送结果”。

## 任务清单 (Strategic Checklist)

- [x] 明确要保持的现有行为边界（不破坏闭关闭环）
- [x] 选择落地形态：多文件包结构（A）
- [x] 定义 `MessageContext/Action/Plugin` 最小接口
- [x] 抽出通用解析器（调息分钟、未平复分钟秒）
- [x] 把闭关逻辑迁移成 `plugins/biguan.py`
- [x] 加入 Scheduler 去重覆盖（按 key）
- [x] 加入配置加载（至少把密钥/群ID/话题ID移出代码）
- [x] 最小验证：用一段历史消息文本做离线回放，确认触发与等待逻辑正确

## 访谈问题（你回答后我会更新本计划；然后等你说“开始执行”再改代码）

已收到你的选择：1A / 2A / 3A

- 落地形态：多文件包结构
- 优先方向：每日类自动化（低风险范围内）
- 风险策略：仅低风险（默认不自动战斗/交易/赌石；涉及资源消耗的日常动作将默认关闭，需显式启用）

1) 你希望架构落地为哪种形态？
- A. 多文件包结构（推荐）：后续加插件最省事
- B. 先保持单文件：只做内部结构化与接口抽象

2) 接下来优先自动化的 Top 3 功能是？
- A. 每日类（`.每日问安`/`.每日献祭`/点卯等）
- B. 资源生产（药园：播种/浇水/除草/收割；灵树灌溉等）
- C. 灵兽（出战/休息/偷菜/寄养等）
- D. 交易（万宝楼/拍卖/摆摊）
- E. 战斗/夺宝/闯塔（高风险，建议默认不自动）

3) 风险策略：哪些行为允许“自动消耗资源/自动战斗”？
- A. 仅低风险：不碰战斗/交易/赌石（推荐）
- B. 中风险：允许日常 + 生产 + 灵兽
- C. 高风险：允许战斗/夺宝/交易（需要更强的风控与状态机）

> 执行前确认：请你回答以上 3 个问题，并回复“开始执行”。我会按你的选择进行最小范围重构，把闭关做成插件并留出扩展位。
