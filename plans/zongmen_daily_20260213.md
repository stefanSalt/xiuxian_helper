# 宗门点卯 + 宗门传功（定时任务）需求澄清与实施计划

日期：2026-02-13

## 背景

在现有插件化架构（`xiuxian_bot/`）基础上新增两个“宗门日常”自动化能力：

- 宗门点卯：每天定时 1 次
- 宗门传功：每天定时 3 次

目标是在不破坏现有【闭关/小药园】逻辑的前提下，提供可配置、可开关、可验证的定时发送能力。

## 目标 (Goals)

- 支持每日定时发送两类指令：点卯 1 次 / 传功 3 次
- 支持配置：
  - 指令文本（避免我猜错命令）
  - 执行时间（HH:MM 或时间窗口）
  - 启用开关（默认关闭）
  - Dry-run 与限流复用现有机制
- 稳定：脚本重启后能继续按“当日/次日”的规则运行（不需要依赖系统回复才能续航）

## 非目标 (Non-Goals)

- 不做宗门相关的复杂策略（例如最优传功对象、贡献管理、宗门任务链等）
- 不做自动加入宗门/自动切换宗门
- 不做高风险行为（战斗/交易/赌石）

## 方案草案（最小改动）

- 新增 `plugins/zongmen.py` 或复用 `plugins/daily.py`（二选一，推荐单独插件，开关更清晰）。
- 定时能力优先由 `app.py` 在启动后注册“循环定时任务”（可取消/可重启），避免依赖“收到回复消息才会继续调度”的不确定性。

## 访谈问题（你回答后我会更新计划；然后等你说“开始执行”再改代码）

已收到你的选择：1A / 2A / 3A / 4A / 5B

- 指令：点卯 `宗门点卯`；传功 `宗门传功`（是否带 `.` 以你实际游戏为准，已做成可配置项）
- 传功前置：需要“回复你的一条有价值的发言”（选择策略 A：先发心得，再回复心得发送传功指令）
- 时间策略：点卯固定时间 `09:37`；传功固定 3 个时间点 `09:38,09:40,09:43`
- 启动补做：若已过今天设定时间，仍立刻补做一次
- 风控：直接真发（`DRY_RUN=0`）
  - 心得文本：`宗门传功`（实现里会做一次防御：若心得与指令完全相同，会自动加前缀 `心得：` 避免被当作指令）

已收集到的系统回包样例（来自 `imgs/` 截图转写，用于解析与容错）：

- 传功要求回复：`此神通需回复你的一条有价值的发言，方可为宗门记录功法。`
- 传功成功：`传功成功记录！你为宗门贡献了心得，获得了 30 点贡献。今日已传功 1/3 次。`
- 传功次数已满：`你今日传功过于频繁，元神消耗过剧，请明日再来吧。每日最多传功 3次。`
- 点卯成功：`点卯成功！你获得了 15 点宗门贡献。你已连续点卯 2 天。`
- 点卯已完成：`今日已点卯，道友明日再来吧。`

已补齐，进入执行阶段。

1) 两个指令的**准确文本**是什么？（请选择或直接粘贴）
- A. 点卯：`.宗门点卯`；传功：`.宗门传功`
- B. 点卯：`.点卯`；传功：`.传功`
- C. 其它（请粘贴两条指令原文）

2) 每天点卯的时间（本机时区执行）：
- A. 固定时间（你给 `HH:MM`，例如 `08:05`）（推荐）
- B. 时间窗口随机（你给 `HH:MM-HH:MM`，例如 `08:00-08:30`）

3) 每天传功三次的时间策略：
- A. 固定 3 个时间点（你给 `HH:MM,HH:MM,HH:MM`，例如 `09:00,14:00,21:00`）（推荐）
- B. 从某个起始时间开始，每隔 N 小时一次（你给起始 `HH:MM` + `N`）
- C. 在一个窗口内随机 3 次（你给 `HH:MM-HH:MM`）

4) “脚本当天启动较晚”时是否需要补做：
- A. 若已过今天设定时间，仍立刻补做一次（推荐，避免漏奖励/次数）
- B. 严格按下一次设定时间执行（不补做）

5) 风控（你之前药园选择过“直接真发”，这里再确认一次）：
- A. 先 `DRY_RUN=1` 观察 1 天再改为真发（推荐）
- B. 直接真发

6) 请你提供 2~4 段“原始文本”（不要截图，直接复制 TG 的文字）用于我做更稳的识别/容错（可选但强烈建议）：
- (a) 点卯成功/失败的一条系统回复
- (b) 传功成功/失败的一条系统回复
- (c) 若存在“冷却/次数不足/修为不足”等提示，再补 1 条

## 实施清单（执行阶段）

- [x] 新增配置项：启用开关、指令文本、时间点、补做策略
- [x] 新增宗门插件：只负责“何时发什么”，不耦合 telethon
- [x] 启动时注册定时任务；退出时可取消（Ctrl+C 体面退出）
- [x] 离线测试：时间计算与“今日/次日补做”逻辑
- [ ] 运行验证：真群观察一天（如需更稳可先 `DRY_RUN=1`）
