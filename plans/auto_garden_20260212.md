# 自动种植（小药园）需求澄清与实施计划

日期：2026-02-12

## 背景

在现有插件化架构（`xiuxian_bot/`）基础上新增“自动种植”能力，目标是对【小药园】进行自动化操作：

- `.小药园` 查看灵田状态（首次会自动开辟）
- `.播种 <种子名>` 一键播种
- `.采药` 一键采药（收获成熟灵草）
- `.除草/.除虫/.浇水` 一键处理负面事件
- `.扩建药园`（消耗贡献，低风险策略下默认不自动）

> 说明文档（节选）来自 `https://linux.do/t/topic/888560`（Discourse JSON）。

## 目标 (Goals)

- 在“低风险策略”下实现自动种植闭环（不涉及战斗/交易/赌石）。
- 插件可开关、可 Dry-run、可限流、可配置种子与地块范围。
- 支持“主动巡检”：按配置每小时发送一次 `.小药园`，并在必要时依据系统回复触发后续动作。

## 非目标 (Non-Goals)

- 不做“自动扩建药园/自动消耗贡献”。
- 不做复杂的库存/最优收益策略（先保证稳定可用）。
- 不在本轮实现灵树系统（`.灵树状态/.灵树灌溉`），除非你明确需要。

## 关键不确定点（必须澄清）

自动化是否可行，取决于系统回复的格式（决定我们能否可靠解析）：

- `.小药园` 的输出格式：每块地如何表示“空闲/生长中/成熟/出现事件”
- 播种成功/失败提示文本
- 成熟提醒/可采药提示文本
- 负面事件（杂草/虫害/缺水）的提示文本
- 是否存在操作冷却提示（例如“灵气尚未平复 … 后再试”）以及是否包含你的名字

## 访谈问题（你回答后我会更新计划；然后等你说“开始执行”再改代码）

已收到你的选择：1A / 2B / 3A / 4B / 5B（每小时一次） / 6B

- 已加入黄枫谷，能正常使用 `.小药园`
- 全闭环：自动播种 + 自动维护 + 自动采药
- 播种策略：固定一种种子（待确认种子名）
- 地块范围：所有地块
- 触发方式：主动巡检（每小时 `.小药园`）
- 风控：直接真发

补充：你确认支持“一键操作”（无需地块编号）

- 一键播种：`.播种 <种子名>`（例如 `.播种 清灵草种子`）
- 一键浇水：`.浇水`
- 一键除虫：`.除虫`
- 一键除草：`.除草`
- 一键采药：`.采药`

你提供的截图信息里，已能确定部分系统回复格式（用于编写解析器与决策）：

- `.小药园`：
  - 标题示例：`【黄枫谷·小药园】(灵田总数: 3块)`
  - 地块行示例：`1号灵田: 清灵草种子-生长中 🌱 (剩余: 5小时26分钟47秒)`
  - 事件/状态关键字：`害虫侵扰 🐛`、`杂草横生 🌿`、`灵气干涸 🍂`、`已成熟 ✨`

- `.播种 <种子名>`：
  - 失败：`你的【凝血草种子】数量不足！(需要: 1, 拥有: 0)`
  - 失败：`你的药园中已无空闲的灵田。`
  - 成功：`播种成功！` + `你已成功在 1, 2, 3, ... 号灵田上种下了【清灵草种子】。`

- `.除草`：
  - 成功：`一键除草完成！你消耗了 100 点修为，成功打理了 2 块灵田！`

- `.采药`：
  - 成功：`一键采药完成！你从 11 块灵田中总计收获了：【凝血草】x25！`

1) 你当前是否已经加入黄枫谷并能使用【小药园】？
- A. 是（能正常 `.小药园`）
- B. 不确定/还没加入

2) 自动化范围（推荐从最小闭环开始）：
- A. 仅自动维护 + 自动采药（播种仍手动）（最稳/最安全，推荐）
- B. 自动播种 + 自动维护 + 自动采药（全闭环）

3) 播种策略（仅当你选 2B 时需要）：
- A. 固定一种种子（你提供 `种子名`）
- B. 按优先级列表（你提供 `种子名1,2,3...`，有哪个用哪个）
- C. 只在检测到空闲地块时提醒我，不自动播种（仍低风险）

4) 地块范围：
- A. 只操作指定地块（你提供编号列表，如 `1,2`）
- B. 操作所有地块（1~8）

5) 触发方式：
- A. 事件驱动（推荐）：只处理系统回复；必要时在“采药/播种后”补一次 `.小药园` 校验
- B. 主动巡检：每 N 分钟自动 `.小药园`（更自动，但更像挂机，风险更高）

6) 风控开关（建议默认）：
- A. 开启 Dry-run 观察 30 分钟再真发（推荐）
- B. 直接真发

7) 请你粘贴 4 段“原始文本”（不要截图），用于我写解析器（每段 3~20 行即可）：
- (a) 你发 `.小药园` 后系统的完整回复
- (b) 你发一次 `.播种 1 xxx` 后系统回复
- (c) 出现一次“除草/除虫/浇水”事件时系统回复
- (d) 成熟后你发 `.采药 1` 的系统回复

## 实施清单（执行阶段）

- [x] 新增 `plugins/garden.py`（默认 `ENABLE_GARDEN=0`）
- [x] 新增解析器：识别地块状态、事件类型、成熟/空闲（关键字解析）
- [x] 新增调度 key：`garden.poll` / `garden.action.*`（scheduler 覆盖去重）
- [ ] 兼容冷却提示：收到“灵气尚未平复 …”时自动重试上一次园艺动作（如可可靠识别）
- [x] 离线测试：用截图转写样本跑解析与决策（不连 TG）

## 仍需补齐的 2 个最小信息（不影响开始编码，但有助于更稳）

已补齐：

1) 固定播种种子名：建议在 `.env` 配置 `GARDEN_SEED_NAME`（默认示例：`清灵草种子`）
2) 已收到 `.采药` 成功回复样例（见上）
